---
title: "3c. Functional Data - Fig 2"
author: "Avril Metcalfe-Roach"
date: "`r Sys.Date()`"
output: html_document
---

```{r}
library(phyloseq)
library(ggpubr)
library(data.table)
library(tidyverse)
library(readxl)
library(scales)
```

# Confusion Matrix

```{r Status}
conf.status = read_xlsx('../../PD_2023_RF_Analysis/Outputs/RF Confusion Matrix Values - Status.xlsx') %>% 
  select(-any_of("...1")) %>% 
  pivot_wider(names_from = Feature, values_from = n) %>% 
  mutate(Accuracy = round((TP+TN)/(TP+TN+FP+FN),3)) %>% 
  mutate(Type = ifelse(Vars=='Covar','Covar',
                       ifelse(str_detect(Vars,'&'),'Taxa + Covar','Taxa'))) %>% 
  select(Analysis,Type,Vars,Accuracy)
temp = conf.status %>% filter(Vars=='Covar') %>% 
  pivot_wider(names_from = Vars, values_from = Accuracy) %>% 
  select(-Type)
temp2 = conf.status %>% filter(Vars != 'Covar') %>% 
  mutate(Vars = str_remove_all(Vars,' & Covar')) %>% 
  pivot_wider(names_from = Type, values_from = Accuracy)
conf.status = temp2 %>% left_join(temp) %>% select(Analysis, Vars,Covar,everything()) %>% 
  rename(Dataset=Vars) %>% 
  mutate(`Taxa (Delta)` = Taxa - Covar,
         `Taxa+Covar (Delta)` = `Taxa + Covar` - Covar)
```

```{r Progression}
conf.prog = read_xlsx('../../PD_2023_RF_Analysis/Outputs/RF Confusion Matrix Values - Progression.xlsx') %>% 
  select(-any_of("...1")) %>% 
  pivot_wider(names_from = Feature, values_from = n) %>% 
  mutate(Accuracy = round((TP+TN)/(TP+TN+FP+FN),3)) %>% 
  mutate(Type = ifelse(Vars=='Covar','Covar',
                       ifelse(str_detect(Vars,'&'),'Taxa + Covar','Taxa'))) %>% 
  select(Analysis,Type,Vars,Accuracy)
temp = conf.prog %>% filter(Vars=='Covar') %>% 
  pivot_wider(names_from = Vars, values_from = Accuracy) %>% 
  select(-Type)
temp2 = conf.prog %>% filter(Vars != 'Covar') %>% 
  mutate(Vars = str_remove_all(Vars,' & Covar')) %>% 
  pivot_wider(names_from = Type, values_from = Accuracy)
conf.prog = temp2 %>% left_join(temp) %>% select(Analysis, Vars,Covar,everything()) %>% 
  rename(Dataset=Vars) %>% 
  mutate(`Taxa (Delta)` = Taxa - Covar,
         `Taxa+Covar (Delta)` = `Taxa + Covar` - Covar)
```

```{r}
conftable = conf.status %>% rbind(conf.prog)
write.csv(conftable,'../Results/6. Random Forest/Accuracy Table.csv',row.names = F)
```


# Importance Values - Status

```{r Formatting function and dataframes}
format_features = function(v){
  temp = sapply(v,function(x){
    if(str_detect(x,'s__')){
      a = x %>% str_remove('s__') %>% str_split('_') %>% .[[1]]
      a[1] = paste(str_sub(a[1],end=1),'.')
      return(paste(a[1],a[2]))
    } else {
      return(str_wrap(x,20))
    }
  })
  return(temp)
}
fix = tibble(Feature = c('Sex','smokeprev_or_before_pd','bristol','logcoffeeperday'),
             fix = c('Sex (Male)', "Ever Smoked",'Bristol Rating','Coffee/Day'))
meta_names = tibble(Feature = c("PWY-7383: anaerobic energy metabolism (invertebrates, cytosol)",
                                "PWY-6471: peptidoglycan biosynthesis IV (Enterococcus faecium)",
                                "PWY66-409: superpathway of purine nucleotide salvage",
                                "PWY-5177: glutaryl-CoA degradation",     
                                "PWY-7242: D-fructuronate degradation",     
                                "GLUCUROCAT-PWY: superpathway of &beta;-D-glucuronide and D-glucuronate degradation",
                                "GALACT-GLUCUROCAT-PWY: superpathway of hexuronide and hexuronate degradation"),
                    new = c("PWY-7383:\nanaerobic metabolism",
                                "PWY-6471:\npeptidoglycan biosynth.",
                                "PWY66-409:\npurine salvage",
                                "PWY-5177:\nglutaryl-CoA degrad.",     
                                "PWY-7242:\nfructuronate degrad.",     
                                "GLUCUROCAT-PWY:\nglucuronide/ate degrad.",
                                "GALACT-GLUCUROCAT-PWY:\nhexuronide/ate degrad."))
key = read.csv('../Reference Files/EC_key.csv') %>% rename(Feature=EC) %>% select(-EC2) %>% 
  mutate(ec = sapply(ec, function(x) x %>% str_split(' // ') %>% .[[1]] %>% .[1]))
```

```{r Formatted Importance Values}
# Calculate Directions for each variable (PD vs Ctrl)
d1 = readxl::read_xlsx('../Results/1. Differential Abundance - Taxonomy/DA_Multivar_Stats.xlsx',sheet = 'Species') %>%
  filter(Variable == 'StatusPD') %>% 
  select(Species,association_dir) %>% unique()
d2 = readxl::read_xlsx('../Results/3. Functional Analysis/DA_MetaCyc_Stats.xlsx',sheet='multivar') %>% 
  filter(Variable=='StatusPD') %>% 
  select(Species,association_dir) %>% unique()
d3 = readxl::read_xlsx('../Results/3. Functional Analysis/DA_KO_Stats.xlsx',sheet='multivar') %>% 
  filter(Variable=='StatusPD') %>% 
  select(Species,association_dir) %>% unique()
d4 = readxl::read_xlsx('../Results/3. Functional Analysis/DA_COG Enzymes_Stats.xlsx',sheet='multivar') %>% 
  filter(Variable=='StatusPD') %>% 
  select(Species,association_dir) %>% unique()
d5 = readxl::read_xlsx('../Results/3. Functional Analysis/DA_EC_Stats.xlsx',sheet='multivar') %>% 
  filter(Variable=='StatusPD') %>% 
  select(Species,association_dir) %>% unique()

ts7 = read.csv('../Reference Files/bacterial_metabolites.csv')
df = read.csv('../../PD_2023_RF_Analysis/Datasets/FOR RF - Status - Metabolites - Annotated Only.csv', check.names = F) %>% 
  mutate(Status = factor(Status),Sex = as.numeric(Sex=='Male')) %>% 
  pivot_longer(cols=any_of(ts7$Metabolite.Identity),names_to = 'met', values_to = 'value') %>% 
  filter(!is.na(value)) %>% 
  group_by(met) %>% 
  group_modify(~summary(glm(Status~value,family='binomial',data=.))$coefficients %>% as.matrix %>% 
                 as.data.frame %>% rownames_to_column('Variable')) %>% 
  filter(Variable!='(Intercept)') %>% 
  mutate(association_dir = ifelse(Estimate==0,'Neutral',ifelse(Estimate<0,"Ctrl",'PD'))) %>% 
  select(met,association_dir) %>% rename(Species=met)
cov = c('bristol','Sex','logcoffeeperday','smokeprev_or_before_pd')
dfcov = read.csv('../../PD_2023_RF_Analysis/Datasets/FOR RF - Status - Taxonomy.csv', check.names = F) %>% 
  mutate(Status = factor(Status),Sex = as.numeric(Sex=='Male'),
         smokeprev_or_before_pd = as.numeric(smokeprev_or_before_pd=='Yes')) %>% 
  pivot_longer(cols=all_of(cov),names_to = 'met', values_to = 'value') %>% 
  filter(!is.na(value)) %>% 
  group_by(met) %>% 
  group_modify(~summary(glm(Status~value,family='binomial',data=.))$coefficients %>% as.matrix %>% 
                 as.data.frame %>% rownames_to_column('Variable')) %>% 
  filter(Variable!='(Intercept)') %>% 
  mutate(association_dir = ifelse(Estimate==0,'Neutral',ifelse(Estimate<0,"Ctrl",'PD'))) %>% 
  select(met,association_dir) %>% rename(Species=met)

# All associations with Status
dir = rbind(d1,d2,d3,d4,d5,df,dfcov)

# Load Importance Values
imp = read_xlsx('../../PD_2023_RF_Analysis/Outputs/RF Importance Values - Status - Covars.xlsx') %>% mutate(Data='Covar') %>% 
  full_join(read_xlsx('../../PD_2023_RF_Analysis/Outputs/Taxonomy/RF Importance Values - Status - Taxonomy.xlsx', 
                      sheet='Taxonomy') %>% mutate(Data='Taxonomy')) %>% 
  full_join(read_xlsx('../../PD_2023_RF_Analysis/Outputs/Taxonomy/RF Importance Values - Status - Taxonomy.xlsx', 
                      sheet='Taxonomy & Covar') %>% mutate(Data='Taxonomy & Covar')) %>% 
  full_join(read_xlsx('../../PD_2023_RF_Analysis/Outputs/MetaCyc/RF Importance Values - Status - MetaCyc.xlsx', 
                      sheet='MetaCyc') %>% mutate(Data='MetaCyc')) %>% 
  full_join(read_xlsx('../../PD_2023_RF_Analysis/Outputs/MetaCyc/RF Importance Values - Status - MetaCyc.xlsx', 
                      sheet='MetaCyc & Covar') %>% mutate(Data='MetaCyc & Covar')) %>% 
  full_join(read_xlsx('../../PD_2023_RF_Analysis/Outputs/KO/RF Importance Values - Status - KO.xlsx', 
                      sheet='KO') %>% mutate(Data='KO')) %>% 
  full_join(read_xlsx('../../PD_2023_RF_Analysis/Outputs/KO/RF Importance Values - Status - KO.xlsx', 
                      sheet='KO & Covar') %>% mutate(Data='KO & Covar')) %>% 
  full_join(read_xlsx('../../PD_2023_RF_Analysis/Outputs/COG/RF Importance Values - Status - COG.xlsx', 
                      sheet='COG') %>% mutate(Data='COG')) %>% 
  full_join(read_xlsx('../../PD_2023_RF_Analysis/Outputs/COG/RF Importance Values - Status - COG.xlsx', 
                      sheet='COG & Covar') %>% mutate(Data='COG & Covar')) %>% 
  full_join(read_xlsx('../../PD_2023_RF_Analysis/Outputs/EC/RF Importance Values - Status - EC.xlsx', 
                      sheet='EC') %>% mutate(Data='EC')) %>% 
  full_join(read_xlsx('../../PD_2023_RF_Analysis/Outputs/EC/RF Importance Values - Status - EC.xlsx', 
                      sheet='EC & Covar') %>% mutate(Data='EC & Covar')) %>% 
  full_join(read_xlsx('../../PD_2023_RF_Analysis/Outputs/Metabolites/RF Importance Values - Status - Metabolites Annot&Covar.xlsx', 
                      sheet='Metabolites') %>% mutate(Data='Metabolites')) %>% 
  full_join(read_xlsx('../../PD_2023_RF_Analysis/Outputs/Metabolites/RF Importance Values - Status - Metabolites Annot&Covar.xlsx', 
                      sheet='Metabolites & Covar') %>% mutate(Data='Metabolites & Covar'))

# Add direction info and format the Feature names for plotting
imp2 = imp %>% left_join(dir %>% rename(Feature = Species)) %>% 
  left_join(fix) %>% mutate(Feature = ifelse(!is.na(fix),fix,Feature)) %>% 
  left_join(meta_names) %>% mutate(Feature = ifelse(!is.na(new),new,Feature)) %>% 
  mutate(Feature = format_features(.$Feature)) 
imp2$Feature[str_detect(imp2$Data,'EC|COG|KO')] = sapply(imp2$Feature[str_detect(imp2$Data,'EC|COG|KO')],
                                                            function(x) x %>% str_split(':') %>% .[[1]] %>% .[1])
imp2 = imp2 %>% mutate(Feature = ifelse(str_detect(Data,'EC|COG|KO'), str_remove_all(Feature,' |\n'),Feature))
imp2 = imp2 %>% 
  left_join(key) %>% 
  mutate(Feature = ifelse(!is.na(ec),ec,Feature)) %>% 
  select(-ec,-new,-fix) %>% 
  rename(`PD vs Ctrl` = association_dir) %>% 
  mutate(`PD vs Ctrl` = ifelse(`PD vs Ctrl` == 'Positive','PD',
                               ifelse(`PD vs Ctrl` == 'Negative','Ctrl',`PD vs Ctrl`)))

# If it's control associated, change the Importance value to a negative
imp3 = imp2 %>% mutate(Importance = ifelse(`PD vs Ctrl`=='Ctrl',Importance*-1,Importance)) %>% 
  arrange(Importance) %>% 
  mutate(Data = factor(Data, levels = c('Covar',sort(unique(.$Data))[sort(unique(.$Data))!='Covar']))) %>% 
  arrange(Data) %>% 
  select(-`...1`)

# For reference below:
imp4 = imp2 %>% rename(fixed = Feature) %>% left_join(imp)
```

```{r Save Importance Table}
L = list(Taxonomy = imp3 %>% filter(str_detect(Data,'Taxonomy') | Data=='Covar'),
         MetaCyc = imp3 %>% filter(str_detect(Data,'MetaCyc') | Data=='Covar'),
         KO = imp3 %>% filter(str_detect(Data,'KO') | Data=='Covar'),
         COG = imp3 %>% filter(str_detect(Data,'COG') | Data=='Covar'),
         EC = imp3 %>% filter(str_detect(Data,'EC') | Data=='Covar'),
         Metabolites = imp3 %>% filter(str_detect(Data,'Metabolites') | Data=='Covar'))

writexl::write_xlsx(L,'../Results/6. Random Forest/RF Importance Values - Status - With Directions.xlsx')
```

```{r Plot Importance Values}
hex <- scales::hue_pal()(2) %>% rev()

# Taxonomy
p1 = imp3 %>% filter(Data=='Covar') %>% mutate(Feature=factor(Feature,levels=.$Feature)) %>% 
    ggplot(aes(y = Importance, x = Feature, fill=`PD vs Ctrl`)) + geom_col() +
    scale_fill_manual(values = hex) +
    theme_classic(base_size=18) +
    theme(legend.position = 'none')  +  
  scale_y_continuous(expand = expansion(mult = c(0,0.15))) +xlab(NULL) + ylab('Importance') +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
p2 = imp3 %>% filter(Data=='Taxonomy') %>% mutate(Feature=factor(Feature,levels=.$Feature)) %>% 
    ggplot(aes(y = Importance, x = Feature, fill=`PD vs Ctrl`)) + geom_col() +
    scale_fill_manual(values = hex) +
    theme_classic(base_size=18) +
    theme(legend.position = 'none')  +  
  scale_y_continuous(expand = expansion(mult = c(0,0.15))) +xlab(NULL) + ylab(NULL) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
p3 = imp3 %>% filter(Data=='Taxonomy & Covar') %>% mutate(Feature=factor(Feature,levels=.$Feature)) %>% 
    ggplot(aes(y = Importance, x = Feature, fill=`PD vs Ctrl`)) + geom_col() +
    scale_fill_manual(values = hex) +
    theme_classic(base_size=18) +
    theme(legend.position = 'none')  +  
  scale_y_continuous(expand = expansion(mult = c(0,0.15))) +xlab(NULL) + ylab(NULL) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggarrange(p1,p2,p3, ncol=3, widths = c(4,6,8))

ggsave('../Results/6. Random Forest/Importance Scores - Status - Taxonomy.jpeg',height=3.5, width=11)

# MetaCyc
p4 = imp3 %>% filter(Data=='MetaCyc') %>% 
  mutate(Feature=factor(Feature,levels=.$Feature)) %>% 
    ggplot(aes(y = Importance, x = Feature, fill=`PD vs Ctrl`)) + geom_col() +
    scale_fill_manual(values = hex) +
    theme_classic(base_size=16) +
    theme(legend.position = 'none')  +  
  scale_y_continuous(expand = expansion(mult = c(0,0.15))) +xlab(NULL) + ylab(NULL) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
p5 = imp3 %>% filter(Data=='MetaCyc & Covar') %>%
  mutate(Feature=factor(Feature,levels=.$Feature)) %>% 
    ggplot(aes(y = Importance, x = Feature, fill=`PD vs Ctrl`)) + geom_col() +
    scale_fill_manual(values = hex) +
    theme_classic(base_size=16) +
    theme(legend.position = 'none')  +  
  scale_y_continuous(expand = expansion(mult = c(0,0.15))) +xlab(NULL) + ylab(NULL) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggarrange(p4,p5, ncol=2, widths = c(6,8))

ggsave('../Results/6. Random Forest/Importance Scores - Status - MetaCyc.jpeg',height=4, width=11)

# KO
p4 = imp3 %>% filter(Data=='KO') %>% 
  mutate(Feature=factor(Feature,levels=.$Feature)) %>% 
    ggplot(aes(y = Importance, x = Feature, fill=`PD vs Ctrl`)) + geom_col() +
    scale_fill_manual(values = hex) +
    theme_classic(base_size=16) +
    theme(legend.position = 'none')  +  
  scale_y_continuous(expand = expansion(mult = c(0,0.15))) +xlab(NULL) + ylab('Importance') +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
p5 = imp3 %>% filter(Data=='KO & Covar') %>%
  mutate(Feature=factor(Feature,levels=.$Feature)) %>% 
    ggplot(aes(y = Importance, x = Feature, fill=`PD vs Ctrl`)) + geom_col() +
    scale_fill_manual(values = hex) +
    theme_classic(base_size=16) +
    theme(legend.position = 'none')  +  
  scale_y_continuous(expand = expansion(mult = c(0,0.15))) +xlab(NULL) + ylab('Importance') +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggarrange(p4,p5, nrow=2)

ggsave('../Results/6. Random Forest/Importance Scores - Status - KO.jpeg',height=6, width=11)

# EC
p4 = imp3 %>% filter(Data=='EC') %>%
  .[-which(duplicated(.$Feature)),] %>% 
  mutate(Feature=factor(Feature,levels=.$Feature)) %>% 
    ggplot(aes(y = Importance, x = Feature, fill=`PD vs Ctrl`)) + geom_col() +
    scale_fill_manual(values = hex) +
    theme_classic(base_size=16) +
    theme(legend.position = 'none')  +  
  scale_y_continuous(expand = expansion(mult = c(0,0.15))) +xlab(NULL) + ylab('Importance') +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
p5 = imp3 %>% filter(Data=='EC & Covar') %>%
  .[-which(duplicated(.$Feature)),] %>% 
  mutate(Feature=factor(Feature,levels=.$Feature)) %>% 
    ggplot(aes(y = Importance, x = Feature, fill=`PD vs Ctrl`)) + geom_col() +
    scale_fill_manual(values = hex) +
    theme_classic(base_size=16) +
    theme(legend.position = 'none')  +  
  scale_y_continuous(expand = expansion(mult = c(0,0.15))) +xlab(NULL) + ylab('Importance') +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggarrange(p4,p5, nrow=2)

ggsave('../Results/6. Random Forest/Importance Scores - Status - EC.jpeg',height=6, width=11)

# COG
p4 = imp3 %>% filter(Data=='COG') %>% 
  mutate(Feature=factor(Feature,levels=.$Feature)) %>% 
    ggplot(aes(y = Importance, x = Feature, fill=`PD vs Ctrl`)) + geom_col() +
    scale_fill_manual(values = hex) +
    theme_classic(base_size=16) +
    theme(legend.position = 'none')  +  
  scale_y_continuous(expand = expansion(mult = c(0,0.15))) +xlab(NULL) + ylab('Importance') +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
p5 = imp3 %>% filter(Data=='COG & Covar') %>%
  mutate(Feature=factor(Feature,levels=.$Feature)) %>% 
    ggplot(aes(y = Importance, x = Feature, fill=`PD vs Ctrl`)) + geom_col() +
    scale_fill_manual(values = hex) +
    theme_classic(base_size=16) +
    theme(legend.position = 'none')  +  
  scale_y_continuous(expand = expansion(mult = c(0,0.15))) +xlab(NULL) + ylab('Importance') +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggarrange(p4,p5, nrow=2)

ggsave('../Results/6. Random Forest/Importance Scores - Status - COG.jpeg',height=6, width=11)

# Metabolites
p4 = imp3 %>% filter(Data=='Metabolites') %>% 
  mutate(Feature=factor(Feature,levels=.$Feature)) %>% 
    ggplot(aes(y = Importance, x = Feature, fill=`PD vs Ctrl`)) + geom_col() +
    scale_fill_manual(values = hex) +
    theme_classic(base_size=16) +
    theme(legend.position = 'none')  +  
  scale_y_continuous(expand = expansion(mult = c(0,0.15))) +xlab(NULL) + ylab('Importance') +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
p5 = imp3 %>% filter(Data=='Metabolites & Covar') %>%
  mutate(Feature=factor(Feature,levels=.$Feature)) %>% 
    ggplot(aes(y = Importance, x = Feature, fill=`PD vs Ctrl`)) + geom_col() +
    scale_fill_manual(values = hex) +
    theme_classic(base_size=16) +
    theme(legend.position = 'none')  +  
  scale_y_continuous(expand = expansion(mult = c(0,0.15))) +xlab(NULL) + ylab('Importance') +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggarrange(p4,p5, nrow=2)

ggsave('../Results/6. Random Forest/Importance Scores - Status - Metabolites.jpeg',height=8, width=11)
```

# Models - Status

```{r Plot Function}
make_plot = function(m,ylab,comp,df=df){
  # Adjust each model so that the first group's median is shifted to zero.
  # m=m10;ylab='EC';comp=list(c('PD','Ctrl'));df=df
  m$Variable = str_remove_all(m$Variable,'`')
  testvar = f %>% as.character() %>% .[2]
  temp = df %>% select(Sample,!!sym(testvar),any_of(m$Variable)) %>% 
    pivot_longer(cols = any_of(m$Variable), 
                 names_to = 'Variable', values_to = 'value') %>% 
    left_join(m) %>% 
    mutate(value = value*Estimate) %>% 
    group_by(Sample,!!sym(testvar)) %>% 
    summarise(value = sum(value)) %>% 
    mutate(group = ifelse(Sample %in% train_set$Sample,'Train','Test')) %>% 
    mutate(group = factor(group, levels = c('Train','Test')))
  control_grp = levels(df[[testvar]])[1]
  adjust = temp$value[temp[[testvar]]==control_grp] %>% median
  temp$value = temp$value - adjust # control group median to zero, it'll be easier to compare plots
  p=temp %>% 
    ggplot(aes(!!sym(testvar),value,fill=!!sym(testvar))) +
    geom_boxplot(outlier.shape = NA) +
    geom_jitter(height=0,width=0.2) +
    theme_classic(base_size = 18) + 
    facet_wrap('group') +
    ggpubr::stat_compare_means(size=5, comparisons = comp, label='p.signif') +
    ylab(ylab) + xlab(NULL) + 
    theme(legend.position = 'none')  +  
    scale_y_continuous(expand = expansion(mult = c(0.05,0.15)))
  return(p)
}
```

```{r Make Plots that represent RF/combinatorial approach}
# To be included in the model, the importance score has to be more than 33% of the biggest importance value.
top_terms = 0.33

# Samples that were used for training in RF.
train_set = read_xlsx('../../PD_2023_RF_Analysis/Outputs/RF Training Samples.xlsx')

df = read.csv('../../PD_2023_RF_Analysis/Datasets/FOR RF - Status - Taxonomy.csv') %>% 
  mutate(Status = factor(Status),
         Sex = as.numeric(Sex=='Male'),
         smokeprev_or_before_pd = as.numeric(smokeprev_or_before_pd=='Yes')) %>% 
  mutate_at(vars(contains('s__')), rescale)
taxa = names(df %>% select(contains('s__')))
cov = c('bristol','Sex','logcoffeeperday','smokeprev_or_before_pd')


# Count number of people
test = df %>% mutate(group = ifelse(Sample %in% train_set$Sample,"Train",'Test'))
table(test$Status,test$group)

# Covars
to_test = imp4 %>% filter(Data=='Covar') %>% filter(Importance>top_terms*max(.$Importance)) %>% pull(Feature)
f = as.formula(paste0('Status~',paste(to_test,collapse = '+')))
m1 = summary(glm(f, family= 'binomial', data = df[df$Sample %in% train_set$Sample,]))$coefficients %>% 
  as.matrix() %>% as.data.frame() %>% 
  rownames_to_column('Variable')
p1 = make_plot(m1,"Covar Only",list(c('Ctrl','PD')),df)

# Taxa
to_test = imp4 %>% filter(Data=='Taxonomy') %>% filter(Importance>top_terms*max(.$Importance)) %>% pull(Feature)
f = as.formula(paste0('Status~',paste(to_test,collapse = '+')))
m2 = summary(glm(f, family= 'binomial', data = df[df$Sample %in% train_set$Sample,]))$coefficients %>% 
  as.matrix() %>% as.data.frame() %>% 
  rownames_to_column('Variable')
p2 = make_plot(m2,"Taxonomy",list(c('Ctrl','PD')),df)

# Taxa, Covars
to_test = imp4 %>% filter(Data=='Taxonomy & Covar') %>% filter(Importance>top_terms*max(.$Importance)) %>% pull(Feature)
f = as.formula(paste0('Status~',paste(to_test,collapse = '+')))
m3 = summary(glm(f, family= 'binomial', data = df[df$Sample %in% train_set$Sample,]))$coefficients %>% 
  as.matrix() %>% as.data.frame() %>% 
  rownames_to_column('Variable')
p3 = make_plot(m3,"Taxonomy & Covar",list(c('Ctrl','PD')),df)

ggarrange(p1,p2,p3,ncol=3)

# MetaCyc ~~~~~~~~~~~~~
df = read.csv('../../PD_2023_RF_Analysis/Datasets/FOR RF - Status - MetaCyc.csv') %>% 
  mutate(Status = factor(Status),
         Sex = as.numeric(Sex=='Male'),
         smokeprev_or_before_pd = as.numeric(smokeprev_or_before_pd=='Yes'))
names(df) = sapply(names(df),function(x)x %>% str_split('[.][.]') %>% .[[1]] %>% .[1])
taxa = names(df %>% select(-all_of(cov),-Sample,-Status,-bp))
df = df %>% mutate_at(vars(all_of(taxa)), rescale)

# Taxa
to_test = imp4 %>% filter(Data=='MetaCyc') %>% filter(Importance>top_terms*max(.$Importance)) %>%
  pull(Feature) %>% sapply(function(x) x %>% str_split(': ') %>% .[[1]] %>% .[1] %>% str_replace_all('-','.'))
f = as.formula(paste0('Status~',paste(to_test,collapse = '+')))
m4 = summary(glm(f, family= 'binomial', data = df[df$Sample %in% train_set$Sample,]))$coefficients %>% 
  as.matrix() %>% as.data.frame() %>% 
  rownames_to_column('Variable')
p4 = make_plot(m4,"MetaCyc",list(c('Ctrl','PD')),df)

# Taxa, Covars
to_test = imp4 %>% filter(Data=='MetaCyc & Covar') %>% filter(Importance>top_terms*max(.$Importance)) %>%
  pull(Feature) %>% sapply(function(x) x %>% str_split(': ') %>% .[[1]] %>% .[1] %>% str_replace_all('-','.'))
f = as.formula(paste0('Status~',paste(to_test,collapse = '+')))
m5 = summary(glm(f, family= 'binomial', data = df[df$Sample %in% train_set$Sample,]))$coefficients %>% 
  as.matrix() %>% as.data.frame() %>% 
  rownames_to_column('Variable')
p5 = make_plot(m5,"MetaCyc & Covar",list(c('Ctrl','PD')),df)

ggarrange(p4,p5)

# COG~~~~~~~~~~~~~~~~~~~~~~
df = read.csv('../../PD_2023_RF_Analysis/Datasets/FOR RF - Status - COG.csv') %>% 
  mutate(Status = factor(Status),
         Sex = as.numeric(Sex=='Male'),
         smokeprev_or_before_pd = as.numeric(smokeprev_or_before_pd=='Yes'))
names(df) = sapply(names(df),function(x)x %>% str_split('[.][.]') %>% .[[1]] %>% .[1])
taxa = names(df %>% select(-all_of(cov),-Sample,-Status,-bp))
df = df %>% mutate_at(vars(all_of(taxa)), rescale)

# Taxa
to_test = imp4 %>% filter(Data=='COG') %>% filter(Importance>top_terms*max(.$Importance)) %>%
  pull(Feature) %>% sapply(function(x) x %>% str_split(': ') %>% .[[1]] %>% .[1] %>% str_replace_all('-','.'))
f = as.formula(paste0('Status~',paste(to_test,collapse = '+')))
m6 = summary(glm(f, family= 'binomial', data = df[df$Sample %in% train_set$Sample,]))$coefficients %>% 
  as.matrix() %>% as.data.frame() %>% 
  rownames_to_column('Variable')
p6= make_plot(m6,"COG",list(c('Ctrl','PD')),df)

# Taxa, Covars
to_test = imp4 %>% filter(Data=='COG & Covar') %>% filter(Importance>top_terms*max(.$Importance)) %>%
  pull(Feature) %>% sapply(function(x) x %>% str_split(': ') %>% .[[1]] %>% .[1] %>% str_replace_all('-','.'))
f = as.formula(paste0('Status~',paste(to_test,collapse = '+')))
m7 = summary(glm(f, family= 'binomial', data = df[df$Sample %in% train_set$Sample,]))$coefficients %>% 
  as.matrix() %>% as.data.frame() %>% 
  rownames_to_column('Variable')
p7 = make_plot(m7,"COG & Covar",list(c('Ctrl','PD')),df)

ggarrange(p6,p7)

# KO ~~~~~~~~~~~~~
df = read.csv('../../PD_2023_RF_Analysis/Datasets/FOR RF - Status - KO.csv') %>% 
  mutate(Status = factor(Status),
         Sex = as.numeric(Sex=='Male'),
         smokeprev_or_before_pd = as.numeric(smokeprev_or_before_pd=='Yes'))
names(df) = sapply(names(df),function(x)x %>% str_split('[.][.]') %>% .[[1]] %>% .[1])
taxa = names(df %>% select(-all_of(cov),-Sample,-Status,-bp))
df = df %>% mutate_at(vars(all_of(taxa)), rescale)

# Taxa
to_test = imp4 %>% filter(Data=='KO') %>% filter(Importance>top_terms*max(.$Importance)) %>%
  pull(Feature) %>% sapply(function(x) x %>% str_split(': ') %>% .[[1]] %>% .[1] %>% str_replace_all('-','.'))
f = as.formula(paste0('Status~',paste(to_test,collapse = '+')))
m8 = summary(glm(f, family= 'binomial', data = df[df$Sample %in% train_set$Sample,]))$coefficients %>% 
  as.matrix() %>% as.data.frame() %>% 
  rownames_to_column('Variable')
p8= make_plot(m8,"KO",list(c('Ctrl','PD')),df)

# Taxa, Covars
to_test = imp4 %>% filter(Data=='KO & Covar') %>% filter(Importance>top_terms*max(.$Importance)) %>%
  pull(Feature) %>% sapply(function(x) x %>% str_split(': ') %>% .[[1]] %>% .[1] %>% str_replace_all('-','.'))
f = as.formula(paste0('Status~',paste(to_test,collapse = '+')))
m9 = summary(glm(f, family= 'binomial', data = df[df$Sample %in% train_set$Sample,]))$coefficients %>% 
  as.matrix() %>% as.data.frame() %>% 
  rownames_to_column('Variable')
p9 = make_plot(m9,"KO & Covar",list(c('Ctrl','PD')),df)

ggarrange(p8,p9)

# EC~~~~~~~~~~~~~~~~~~~~~~
df = read.csv('../../PD_2023_RF_Analysis/Datasets/FOR RF - Status - EC.csv', check.names = F) %>% 
  mutate(Status = factor(Status),
         Sex = as.numeric(Sex=='Male'),
         smokeprev_or_before_pd = as.numeric(smokeprev_or_before_pd=='Yes'))
taxa = names(df %>% select(-all_of(cov),-Sample,-Status,-bp))
df = df %>% mutate_at(vars(all_of(taxa)), rescale)

# Taxa
to_test = imp4 %>% filter(Data=='EC') %>% filter(Importance>top_terms*max(.$Importance)) %>%
  pull(Feature)
f = as.formula(paste0('Status~',paste(paste('`',to_test,'`',sep=''),collapse = '+')))
m10 = summary(glm(f, family= 'binomial', data = df[df$Sample %in% train_set$Sample,]))$coefficients %>% 
  as.matrix() %>% as.data.frame() %>% 
  rownames_to_column('Variable')
p10= make_plot(m10,"EC",list(c('Ctrl','PD')),df)

# Taxa, Covars
to_test = imp4 %>% filter(Data=='EC & Covar') %>% filter(Importance>top_terms*max(.$Importance)) %>%
  pull(Feature)
f = as.formula(paste0('Status~',paste(paste('`',to_test,'`',sep=''),collapse = '+')))
m11 = summary(glm(f, family= 'binomial', data = df[df$Sample %in% train_set$Sample,]))$coefficients %>% 
  as.matrix() %>% as.data.frame() %>% 
  rownames_to_column('Variable')
p11 = make_plot(m11,"EC & Covar",list(c('Ctrl','PD')),df)

ggarrange(p10,p11)

# Metabolites~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Samples that were used for training in RF.
train_set = read_xlsx('../../PD_2023_RF_Analysis/Outputs/RF Training Samples - Metabolites.xlsx')
df = read.csv('../../PD_2023_RF_Analysis/Datasets/FOR RF - Status - Metabolites - Annotated Only.csv', check.names = F) %>% 
  mutate(Status = factor(Status),
         Sex = as.numeric(Sex=='Male'),
         smokeprev_or_before_pd = as.numeric(smokeprev_or_before_pd=='Yes'))
taxa = names(df %>% select(-all_of(cov),-Sample,-Status,-bp))
df = df %>% mutate_at(vars(all_of(taxa)), rescale)

# Taxa
to_test = imp4 %>% filter(Data=='Metabolites') %>% filter(Importance>top_terms*max(.$Importance)) %>% pull(Feature)
f = as.formula(paste0('Status~',paste(paste('`',to_test,'`',sep=''),collapse = '+')))
m12 = summary(glm(f, family= 'binomial', data = df[df$Sample %in% train_set$Sample,]))$coefficients %>% 
  as.matrix() %>% as.data.frame() %>% 
  rownames_to_column('Variable')
p12= make_plot(m12,"Metabolites",list(c('Ctrl','PD')),df)

# Taxa, Covars
to_test = imp4 %>% filter(Data=='Metabolites & Covar') %>% filter(Importance>top_terms*max(.$Importance)) %>% pull(Feature)
f = as.formula(paste0('Status~',paste(paste('`',to_test,'`',sep=''),collapse = '+')))
m13 = summary(glm(f, family= 'binomial', data = df[df$Sample %in% train_set$Sample,]))$coefficients %>% 
  as.matrix() %>% as.data.frame() %>% 
  rownames_to_column('Variable')
p13 = make_plot(m13,"Metabolites & Covar",list(c('Ctrl','PD')),df)

ggarrange(p12,p13)
```

```{r Save Plots and Stats}
g1 = ggarrange(p1,nrow=2)
g2 = ggarrange(p2,p3,nrow=2)
g3 = ggarrange(p4,p5,nrow=2)
g4 = ggarrange(p6,p7,nrow=2)
g5 = ggarrange(p8,p9,nrow=2)
g6 = ggarrange(p10,p11,nrow=2)
g7 = ggarrange(p12,p13,nrow=2)

ggarrange(g1,g2,g3,ncol=3)
ggsave('../Results/6. Random Forest/Model Fits - Status p1.jpeg',height=6, width=9)
ggarrange(g4,g6,g5,g7,ncol=4)
ggsave('../Results/6. Random Forest/Model Fits - Status p2.jpeg',height=6, width=12)

# Save model stats
modeldata = p1$data %>% mutate(Data='Covar') %>% 
  rbind(p2$data %>% mutate(Data='Taxonomy')) %>% 
  rbind(p3$data %>% mutate(Data='Taxonomy & Covar')) %>% 
  rbind(p4$data %>% mutate(Data='MetaCyc')) %>% 
  rbind(p5$data %>% mutate(Data='MetaCyc & Covar')) %>% 
  rbind(p6$data %>% mutate(Data='COG')) %>% 
  rbind(p7$data %>% mutate(Data='COG & Covar')) %>% 
  rbind(p8$data %>% mutate(Data='KO')) %>% 
  rbind(p9$data %>% mutate(Data='KO & Covar') %>% 
  rbind(p10$data %>% mutate(Data='EC')) %>% 
  rbind(p11$data %>% mutate(Data='EC & Covar')) %>% 
  rbind(p12$data %>% mutate(Data='Metabolites')) %>% 
  rbind(p13$data %>% mutate(Data='Metabolites & Covar'))) %>% 
  select(Data,group,everything()) %>% select(-`.group`) %>% 
  group_by(Data,group) %>% 
  group_modify(~wilcox.test(value~Status,data=.) %>% broom::tidy()) %>% 
  mutate(method='Wilcoxon rank sum') %>% 
  select(Data,group,method,statistic,p.value) %>% 
  mutate(Data = factor(Data,levels = c('Covar',sort(unique(.$Data))[sort(unique(.$Data))!='Covar']))) %>% 
  arrange(Data)

write.csv(modeldata,'../Results/6. Random Forest/Model Fit - Plot Statistics - Status.csv',row.names = F)
```

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

# Importance Values - Progression

```{r Formatting function and dataframes}
format_features = function(v){
  temp = sapply(v,function(x){
    if(str_detect(x,'s__')){
      a = x %>% str_remove('s__') %>% str_split('_') %>% .[[1]]
      a[1] = paste(str_sub(a[1],end=1),'.')
      return(paste(a[1],a[2]))
    } else {
      return(str_wrap(x,20))
    }
  })
  return(temp)
}
fix = tibble(Feature = c('Sex','smokeprev_or_before_pd','bristol','logcoffeeperday'),
             fix = c('Sex (Male)', "Ever Smoked",'Bristol Rating','Coffee/Day'))
meta_names = tibble(Feature = c("PWY-7383: anaerobic energy metabolism (invertebrates, cytosol)",
                                "PWY-6471: peptidoglycan biosynthesis IV (Enterococcus faecium)",
                                "PWY66-409: superpathway of purine nucleotide salvage",
                                "PWY-5177: glutaryl-CoA degradation",     
                                "PWY-7242: D-fructuronate degradation",     
                                "GLUCUROCAT-PWY: superpathway of &beta;-D-glucuronide and D-glucuronate degradation",
                                "GALACT-GLUCUROCAT-PWY: superpathway of hexuronide and hexuronate degradation"),
                    new = c("PWY-7383:\nanaerobic metabolism",
                                "PWY-6471:\npeptidoglycan biosynth.",
                                "PWY66-409:\npurine salvage",
                                "PWY-5177:\nglutaryl-CoA degrad.",     
                                "PWY-7242:\nfructuronate degrad.",     
                                "GLUCUROCAT-PWY:\nglucuronide/ate degrad.",
                                "GALACT-GLUCUROCAT-PWY:\nhexuronide/ate degrad."))
key = read.csv('../Reference Files/EC_key.csv') %>% rename(Feature=EC) %>% select(-EC2) %>% 
  mutate(ec = sapply(ec, function(x) x %>% str_split(' // ') %>% .[[1]] %>% .[1]))
```

```{r Formatted Importance Values}
# Calculate Directions for each variable (PD vs Ctrl)

d1 = readxl::read_xlsx('../Results/5b. Mixed Model Analysis/Supp Data - Disease Progression Stats.xlsx',sheet = 'Multivar') %>%
  filter(term=='months_last_visit:Abundance',Variable=='mds.total') %>% 
  select(Species,estimate) %>% unique() %>% 
  mutate(association_dir = ifelse(estimate<0,"Slow","Fast")) %>% select(-estimate)
d2 = readxl::read_xlsx('../Results/5b. Mixed Model Analysis/Supp Data - MetaCyc Disease Progression Stats.xlsx',sheet = 'Multivar') %>%
  filter(term=='months_last_visit:Abundance',Variable=='mds.total') %>% 
  select(Species,estimate) %>% unique() %>% 
  mutate(association_dir = ifelse(estimate<0,"Slow","Fast")) %>% select(-estimate)
d3 = readxl::read_xlsx('../Results/5b. Mixed Model Analysis/Supp Data - KEGG Disease Progression Stats.xlsx',sheet = 'Multivar') %>%
  filter(term=='months_last_visit:Abundance',Variable=='mds.total') %>% 
  select(Species,estimate) %>% unique() %>% 
  mutate(association_dir = ifelse(estimate<0,"Slow","Fast")) %>% select(-estimate)
d4 = readxl::read_xlsx('../Results/5b. Mixed Model Analysis/Supp Data - COG Disease Progression Stats.xlsx',sheet = 'Multivar') %>%
  filter(term=='months_last_visit:Abundance',Variable=='mds.total') %>% 
  select(Species,estimate) %>% unique() %>% 
  mutate(association_dir = ifelse(estimate<0,"Slow","Fast")) %>% select(-estimate)
d5 = readxl::read_xlsx('../Results/5b. Mixed Model Analysis/Supp Data - EC Disease Progression Stats.xlsx',sheet = 'Multivar') %>%
  filter(term=='months_last_visit:Abundance',Variable=='mds.total') %>% 
  select(Species,estimate) %>% unique() %>% 
  mutate(association_dir = ifelse(estimate<0,"Slow","Fast")) %>% select(-estimate)

ts7 = read.csv('../Reference Files/bacterial_metabolites.csv')
df = read.csv('../../PD_2023_RF_Analysis/Datasets/FOR RF - Progression - Metabolites - Annotated Only.csv', check.names = F) %>% 
  mutate(Progression = factor(Progression, levels=c('Slow','Med','Fast')),Sex = as.numeric(Sex=='Male')) %>% 
  pivot_longer(cols=any_of(ts7$Metabolite.Identity),names_to = 'met', values_to = 'value') %>% 
  filter(!is.na(value),!is.na(Estimate)) %>% 
  group_by(met) %>% 
  group_modify(~summary(glm(Estimate~value,data=.))$coefficients %>% as.data.frame %>% rownames_to_column('var')) %>% 
  filter(var=='value') %>% 
  select(met,Estimate) %>% rename(Species=met) %>% 
  mutate(association_dir = ifelse(Estimate<0,"Slow",'Fast')) %>% 
  select(-Estimate)
cov = c('bristol','Sex','logcoffeeperday')
dfcov = read.csv('../../PD_2023_RF_Analysis/Datasets/FOR RF - Progression - Taxonomy.csv', check.names = F) %>% 
  mutate(Sex = as.numeric(Sex=='Male')) %>% 
  select(Sample,Estimate,all_of(cov)) %>% 
  pivot_longer(cols=all_of(cov),names_to = 'met', values_to = 'value') %>% 
  filter(!is.na(value),!is.na(Estimate)) %>% 
  group_by(met) %>% 
  group_modify(~summary(glm(Estimate~value,data=.))$coefficients %>% as.data.frame %>% rownames_to_column('var')) %>% 
  filter(var=='value') %>% 
  select(met,Estimate) %>% rename(Species=met) %>% 
  mutate(association_dir = ifelse(Estimate<0,"Slow",'Fast')) %>% 
  select(-Estimate)

# All associations with Status
dir = rbind(d1,d2,d3,d4,d5,df,dfcov)

# Load Importance Values
imp = read_xlsx('../../PD_2023_RF_Analysis/Outputs/RF Importance Values - Progression - Covars.xlsx') %>% mutate(Data='Covar') %>% 
  full_join(read_xlsx('../../PD_2023_RF_Analysis/Outputs/Taxonomy/RF Importance Values - Progression - Taxonomy.xlsx', 
                      sheet='Taxonomy') %>% mutate(Data='Taxonomy')) %>% 
  full_join(read_xlsx('../../PD_2023_RF_Analysis/Outputs/Taxonomy/RF Importance Values - Progression - Taxonomy.xlsx', 
                      sheet='Taxonomy & Covar') %>% mutate(Data='Taxonomy & Covar')) %>% 
  full_join(read_xlsx('../../PD_2023_RF_Analysis/Outputs/MetaCyc/RF Importance Values - Progression - MetaCyc.xlsx', 
                      sheet='MetaCyc') %>% mutate(Data='MetaCyc')) %>% 
  full_join(read_xlsx('../../PD_2023_RF_Analysis/Outputs/MetaCyc/RF Importance Values - Progression - MetaCyc.xlsx', 
                      sheet='MetaCyc & Covar') %>% mutate(Data='MetaCyc & Covar')) %>% 
  full_join(read_xlsx('../../PD_2023_RF_Analysis/Outputs/KO/RF Importance Values - Progression - KO.xlsx', 
                      sheet='KO') %>% mutate(Data='KO')) %>% 
  full_join(read_xlsx('../../PD_2023_RF_Analysis/Outputs/KO/RF Importance Values - Progression - KO.xlsx', 
                      sheet='KO & Covar') %>% mutate(Data='KO & Covar')) %>% 
  full_join(read_xlsx('../../PD_2023_RF_Analysis/Outputs/COG/RF Importance Values - Progression - COG.xlsx', 
                      sheet='COG') %>% mutate(Data='COG')) %>% 
  full_join(read_xlsx('../../PD_2023_RF_Analysis/Outputs/COG/RF Importance Values - Progression - COG.xlsx', 
                      sheet='COG & Covar') %>% mutate(Data='COG & Covar')) %>% 
  full_join(read_xlsx('../../PD_2023_RF_Analysis/Outputs/EC/RF Importance Values - Progression - EC.xlsx', 
                      sheet='EC') %>% mutate(Data='EC')) %>% 
  full_join(read_xlsx('../../PD_2023_RF_Analysis/Outputs/EC/RF Importance Values - Progression - EC.xlsx', 
                      sheet='EC & Covar') %>% mutate(Data='EC & Covar')) %>% 
  full_join(read_xlsx('../../PD_2023_RF_Analysis/Outputs/Metabolites/RF Importance Values - Progression - Metabolites Annot&Covar.xlsx', 
                      sheet='Metabolites') %>% mutate(Data='Metabolites')) %>% 
  full_join(read_xlsx('../../PD_2023_RF_Analysis/Outputs/Metabolites/RF Importance Values - Progression - Metabolites Annot&Covar.xlsx', 
                      sheet='Metabolites & Covar') %>% mutate(Data='Metabolites & Covar'))

# Add direction info and format the Feature names for plotting
imp2 = imp %>% left_join(dir %>% rename(Feature=Species)) %>% 
  left_join(fix) %>% mutate(Feature = ifelse(!is.na(fix),fix,Feature)) %>% 
  left_join(meta_names) %>% mutate(Feature = ifelse(!is.na(new),new,Feature)) %>% 
  mutate(Feature = format_features(.$Feature)) 
imp2$Feature[str_detect(imp2$Data,'EC|COG|KO')] = sapply(imp2$Feature[str_detect(imp2$Data,'EC|COG|KO')],
                                                            function(x) x %>% str_split(':') %>% .[[1]] %>% .[1])
imp2 = imp2 %>% mutate(Feature = ifelse(str_detect(Data,'EC|COG|KO'), str_remove_all(Feature,' |\n'),Feature))
imp2 = imp2 %>% mutate(Feature = ifelse(str_detect(Feature,'ARGININE-DEIMINASE'),'ARGININE-DEIMINASE-RXN',Feature)) %>% 
  left_join(key) %>% 
  mutate(Feature = ifelse(!is.na(ec),ec,Feature)) %>% 
  select(-ec,-new,-fix) %>% 
  rename(`Slow vs Fast` = association_dir) %>% 
  mutate(`Slow vs Fast` = ifelse(`Slow vs Fast` == 'Positive','Fast',
                               ifelse(`Slow vs Fast` == 'Negative','Slow',`Slow vs Fast`)))

# If it's control associated, change the Importance value to a negative
imp3 = imp2 %>% mutate(Importance = ifelse(`Slow vs Fast`=='Slow',Importance*-1,Importance)) %>% 
  arrange(Importance) %>% 
  mutate(Data = factor(Data, levels = c('Covar',sort(unique(.$Data))[sort(unique(.$Data))!='Covar']))) %>% 
  arrange(Data) %>% 
  select(-`...1`)

# For reference below:
imp4 = imp2 %>% rename(fixed = Feature) %>% left_join(imp)
```

```{r Save Importance Table}
L = list(Taxonomy = imp3 %>% filter(str_detect(Data,'Taxonomy') | Data=='Covar'),
         MetaCyc = imp3 %>% filter(str_detect(Data,'MetaCyc') | Data=='Covar'),
         KO = imp3 %>% filter(str_detect(Data,'KO') | Data=='Covar'),
         COG = imp3 %>% filter(str_detect(Data,'COG') | Data=='Covar'),
         EC = imp3 %>% filter(str_detect(Data,'EC') | Data=='Covar'),
         Metabolites = imp3 %>% filter(str_detect(Data,'Metabolites') | Data=='Covar'))

writexl::write_xlsx(L,'../Results/6. Random Forest/RF Importance Values - Progression - With Directions.xlsx')
```

```{r Plot Importance Values}
hex <- scales::hue_pal()(2) %>% rev()

# Taxonomy
p1 = imp3 %>% filter(Data=='Covar') %>% mutate(Feature=factor(Feature,levels=.$Feature)) %>% 
    ggplot(aes(y = Importance, x = Feature, fill=`Slow vs Fast`)) + geom_col() +
    scale_fill_manual(values = hex) +
    theme_classic(base_size=18) +
    theme(legend.position = 'none')  +  
  scale_y_continuous(expand = expansion(mult = c(0,0.15))) +xlab(NULL) + ylab('Importance') +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
p2 = imp3 %>% filter(Data=='Taxonomy') %>% mutate(Feature=factor(Feature,levels=.$Feature)) %>% 
    ggplot(aes(y = Importance, x = Feature, fill=`Slow vs Fast`)) + geom_col() +
    scale_fill_manual(values = hex) +
    theme_classic(base_size=18) +
    theme(legend.position = 'none')  +  
  scale_y_continuous(expand = expansion(mult = c(0,0.15))) +xlab(NULL) + ylab(NULL) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
p3 = imp3 %>% filter(Data=='Taxonomy & Covar') %>% mutate(Feature=factor(Feature,levels=.$Feature)) %>% 
    ggplot(aes(y = Importance, x = Feature, fill=`Slow vs Fast`)) + geom_col() +
    scale_fill_manual(values = hex) +
    theme_classic(base_size=18) +
    theme(legend.position = 'none')  +  
  scale_y_continuous(expand = expansion(mult = c(0,0.15))) +xlab(NULL) + ylab(NULL) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggarrange(p1,p2,p3, ncol=3, widths = c(4,6,8))

ggsave('../Results/6. Random Forest/Importance Scores - Progression - Taxonomy.jpeg',height=3.5, width=11)

# MetaCyc
p4 = imp3 %>% filter(Data=='MetaCyc') %>% 
  mutate(Feature=factor(Feature,levels=.$Feature)) %>% 
    ggplot(aes(y = Importance, x = Feature, fill=`Slow vs Fast`)) + geom_col() +
    scale_fill_manual(values = hex) +
    theme_classic(base_size=16) +
    theme(legend.position = 'none')  +  
  scale_y_continuous(expand = expansion(mult = c(0,0.15))) +xlab(NULL) + ylab(NULL) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
p5 = imp3 %>% filter(Data=='MetaCyc & Covar') %>%
  mutate(Feature=factor(Feature,levels=.$Feature)) %>% 
    ggplot(aes(y = Importance, x = Feature, fill=`Slow vs Fast`)) + geom_col() +
    scale_fill_manual(values = hex) +
    theme_classic(base_size=16) +
    theme(legend.position = 'none')  +  
  scale_y_continuous(expand = expansion(mult = c(0,0.15))) +xlab(NULL) + ylab(NULL) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggarrange(p4,p5, ncol=2, widths = c(6,8))

ggsave('../Results/6. Random Forest/Importance Scores - Progression - MetaCyc.jpeg',height=4, width=11)

# KO
p4 = imp3 %>% filter(Data=='KO') %>% 
  mutate(Feature=factor(Feature,levels=.$Feature)) %>% 
    ggplot(aes(y = Importance, x = Feature, fill=`Slow vs Fast`)) + geom_col() +
    scale_fill_manual(values = hex) +
    theme_classic(base_size=16) +
    theme(legend.position = 'none')  +  
  scale_y_continuous(expand = expansion(mult = c(0,0.15))) +xlab(NULL) + ylab('Importance') +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
p5 = imp3 %>% filter(Data=='KO & Covar') %>%
  mutate(Feature=factor(Feature,levels=.$Feature)) %>% 
    ggplot(aes(y = Importance, x = Feature, fill=`Slow vs Fast`)) + geom_col() +
    scale_fill_manual(values = hex) +
    theme_classic(base_size=16) +
    theme(legend.position = 'none')  +  
  scale_y_continuous(expand = expansion(mult = c(0,0.15))) +xlab(NULL) + ylab(NULL) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggarrange(p4,p5, nrow=2)

ggsave('../Results/6. Random Forest/Importance Scores - Progression - KO.jpeg',height=6, width=11)

# EC
p4 = imp3 %>% filter(Data=='EC') %>%
  .[-which(duplicated(.$Feature)),] %>% 
  mutate(Feature=factor(Feature,levels=.$Feature)) %>% 
    ggplot(aes(y = Importance, x = Feature, fill=`Slow vs Fast`)) + geom_col() +
    scale_fill_manual(values = hex) +
    theme_classic(base_size=16) +
    theme(legend.position = 'none')  +  
  scale_y_continuous(expand = expansion(mult = c(0,0.15))) +xlab(NULL) + ylab('Importance') +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
p5 = imp3 %>% filter(Data=='EC & Covar') %>%
  .[-which(duplicated(.$Feature)),] %>% 
  mutate(Feature=factor(Feature,levels=.$Feature)) %>% 
    ggplot(aes(y = Importance, x = Feature, fill=`Slow vs Fast`)) + geom_col() +
    scale_fill_manual(values = hex) +
    theme_classic(base_size=16) +
    theme(legend.position = 'none')  +  
  scale_y_continuous(expand = expansion(mult = c(0,0.15))) +xlab(NULL) + ylab(NULL) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggarrange(p4,p5, nrow=2)

ggsave('../Results/6. Random Forest/Importance Scores - Progression - EC.jpeg',height=6, width=11)

# COG
p4 = imp3 %>% filter(Data=='COG') %>% 
  mutate(Feature=factor(Feature,levels=.$Feature)) %>% 
    ggplot(aes(y = Importance, x = Feature, fill=`Slow vs Fast`)) + geom_col() +
    scale_fill_manual(values = hex) +
    theme_classic(base_size=16) +
    theme(legend.position = 'none')  +  
  scale_y_continuous(expand = expansion(mult = c(0,0.15))) +xlab(NULL) + ylab('Importance') +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
p5 = imp3 %>% filter(Data=='COG & Covar') %>%
  mutate(Feature=factor(Feature,levels=.$Feature)) %>% 
    ggplot(aes(y = Importance, x = Feature, fill=`Slow vs Fast`)) + geom_col() +
    scale_fill_manual(values = hex) +
    theme_classic(base_size=16) +
    theme(legend.position = 'none')  +  
  scale_y_continuous(expand = expansion(mult = c(0,0.15))) +xlab(NULL) + ylab(NULL) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggarrange(p4,p5, nrow=2)

ggsave('../Results/6. Random Forest/Importance Scores - Progression - COG.jpeg',height=6, width=11)
```

# Models - Progression

```{r Plot Function}
make_plot = function(m,ylab,df=df){
  # Adjust each model so that the first group's median is shifted to zero.
  # m=m6;ylab='COG';comp=list(c('PD','Ctrl'));df=df
  m$Variable = str_remove_all(m$Variable,'`')
  testvar = f %>% as.character() %>% .[2]
  temp = df %>% select(Sample,!!sym(testvar),any_of(m$Variable)) %>% 
    pivot_longer(cols = any_of(m$Variable), 
                 names_to = 'Variable', values_to = 'value') %>% 
    left_join(m) %>% 
    mutate(value = value*Estimate) %>% 
    group_by(Sample,!!sym(testvar)) %>% 
    summarise(value = sum(value)) %>% 
    mutate(group = ifelse(Sample %in% train_set$Sample,'Train','Test')) %>% 
    mutate(group = factor(group, levels = c('Train','Test')))
  control_grp = levels(df[[testvar]])[1]
  adjust = temp$value[temp[[testvar]]==control_grp] %>% median
  temp$value = temp$value - adjust # control group median to zero, it'll be easier to compare plots
  p=temp %>% 
    ggplot(aes(!!sym(testvar),value,fill=!!sym(testvar))) +
    geom_boxplot(outlier.shape = NA) +
    geom_jitter(height=0,width=0.2) +
    theme_classic(base_size = 18) + 
    facet_wrap('group') +
    ggpubr::stat_compare_means(size=5, comparisons = list(c('Slow','Fast')), label='p.signif') +
    ylab(ylab) + xlab(NULL) + 
    theme(legend.position = 'none')  +  
    scale_y_continuous(expand = expansion(mult = c(0.05,0.15))) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
  p = p + ggpubr::stat_compare_means(size=5, comparisons = list(c('Slow','Med')), 
                                     label='p.signif', label.y = max(p$data$value)*1.2)
  return(p)
}
```

```{r Make Plots that represent RF/combinatorial approach}
# To be included in the model, the importance score has to be more than 33% of the biggest importance value.
top_terms = 0.33

# Samples that were used for training in RF.
train_set = read_xlsx('../../PD_2023_RF_Analysis/Outputs/RF Training Samples - Prog.xlsx')

df = read.csv('../../PD_2023_RF_Analysis/Datasets/FOR RF - Progression - Taxonomy.csv') %>% 
  filter(Status=='PD') %>% select(-Status) %>% 
  mutate(Progression = factor(Progression, levels = c("Slow",'Med','Fast')),
         Sex = as.numeric(Sex=='Male'))
taxa = names(df %>% select(contains('s__')))
cov = c('bristol','Sex','logcoffeeperday')

# Count number of people
test = df %>% mutate(group = ifelse(Sample %in% train_set$Sample,"Train",'Test'))
table(test$Progression,test$group)

# Covars
to_test = imp4 %>% filter(Data=='Covar') %>% filter(Importance>top_terms*max(.$Importance)) %>% pull(Feature)
f = as.formula(paste0('Progression~',paste(to_test,collapse = '+')))
m1 = summary(glm(f, family= 'binomial', data = df[df$Sample %in% train_set$Sample,] %>% 
                   filter(Progression != 'Med') %>% droplevels))$coefficients %>% 
  as.matrix() %>% as.data.frame() %>% 
  rownames_to_column('Variable')
p1 = make_plot(m1,"Covar Only",df)

# Taxa
to_test = imp4 %>% filter(Data=='Taxonomy') %>% filter(Importance>top_terms*max(.$Importance)) %>% pull(Feature)
f = as.formula(paste0('Progression~',paste(to_test,collapse = '+')))
m2 = summary(glm(f, family= 'binomial', data = df[df$Sample %in% train_set$Sample,] %>% 
                   filter(Progression != 'Med') %>% droplevels))$coefficients %>% 
  as.matrix() %>% as.data.frame() %>% 
  rownames_to_column('Variable')
p2 = make_plot(m2,"Taxonomy",df)

# Taxa, Covars
to_test = imp4 %>% filter(Data=='Taxonomy & Covar') %>% filter(Importance>top_terms*max(.$Importance)) %>% pull(Feature)
f = as.formula(paste0('Progression~',paste(to_test,collapse = '+')))
m3 = summary(glm(f, family= 'binomial', data = df[df$Sample %in% train_set$Sample,] %>% 
                   filter(Progression != 'Med') %>% droplevels))$coefficients %>% 
  as.matrix() %>% as.data.frame() %>% 
  rownames_to_column('Variable')
p3 = make_plot(m3,"Taxonomy & Covar",df)

ggarrange(p1,p2,p3,ncol=3)

# MetaCyc ~~~~~~~~~~~~~
df = read.csv('../../PD_2023_RF_Analysis/Datasets/FOR RF - Progression - MetaCyc.csv') %>% 
  filter(Status=='PD') %>% select(-Status) %>% 
  mutate(Progression = factor(Progression, levels = c("Slow",'Med','Fast')),
         Sex = as.numeric(Sex=='Male')) %>% 
  select(-Estimate,-current_smoker)
names(df) = sapply(names(df),function(x)x %>% str_split('[.][.]') %>% .[[1]] %>% .[1])
cov = c('bristol','Sex','logcoffeeperday')
taxa = names(df %>% select(-all_of(cov),-Sample,-Progression,-bp))

# Taxa
to_test = imp4 %>% filter(Data=='MetaCyc') %>% filter(Importance>top_terms*max(.$Importance)) %>%
  pull(Feature) %>% sapply(function(x) x %>% str_split(': ') %>% .[[1]] %>% .[1] %>% str_replace_all('-','.'))
f = as.formula(paste0('Progression~',paste(to_test,collapse = '+')))
m4 = summary(glm(f, family= 'binomial', data = df[df$Sample %in% train_set$Sample,] %>% 
                   filter(Progression != 'Med') %>% droplevels))$coefficients %>% 
  as.matrix() %>% as.data.frame() %>% 
  rownames_to_column('Variable')
p4 = make_plot(m4,"MetaCyc",df)

# Taxa, Covars
to_test = imp4 %>% filter(Data=='MetaCyc & Covar') %>% filter(Importance>top_terms*max(.$Importance)) %>%
  pull(Feature) %>% sapply(function(x) x %>% str_split(': ') %>% .[[1]] %>% .[1] %>% str_replace_all('-','.'))
f = as.formula(paste0('Progression~',paste(to_test,collapse = '+')))
m5 = summary(glm(f, family= 'binomial', data = df[df$Sample %in% train_set$Sample,] %>% 
                   filter(Progression != 'Med') %>% droplevels))$coefficients %>% 
  as.matrix() %>% as.data.frame() %>% 
  rownames_to_column('Variable')
p5 = make_plot(m5,"MetaCyc & Covar",df)

ggarrange(p4,p5)

# COG~~~~~~~~~~~~~~~~~~~~~~
df = read.csv('../../PD_2023_RF_Analysis/Datasets/FOR RF - Progression - COG.csv') %>% 
  filter(Status=='PD') %>% select(-Status) %>% 
  mutate(Progression = factor(Progression, levels = c("Slow",'Med','Fast')),
         Sex = as.numeric(Sex=='Male')) %>% 
  select(-Estimate,-current_smoker)
names(df) = sapply(names(df),function(x)x %>% str_split('[.][.]') %>% .[[1]] %>% .[1])
cov = c('bristol','Sex','logcoffeeperday')
taxa = names(df %>% select(-all_of(cov),-Sample,-Progression,-bp))

# Taxa
to_test = imp4 %>% filter(Data=='COG') %>% filter(Importance>top_terms*max(.$Importance)) %>%
  pull(Feature) %>% sapply(function(x) x %>% str_split(': ') %>% .[[1]] %>% .[1] %>% str_replace_all('-','.'))
f = as.formula(paste0('Progression~',paste(to_test,collapse = '+')))
m6 = summary(glm(f, family= 'binomial', data = df[df$Sample %in% train_set$Sample,] %>% 
                   filter(Progression != 'Med') %>% droplevels))$coefficients %>% 
  as.matrix() %>% as.data.frame() %>% 
  rownames_to_column('Variable')
p6 = make_plot(m6,"COG",df)

# Taxa, Covars
to_test = imp4 %>% filter(Data=='COG & Covar') %>% filter(Importance>top_terms*max(.$Importance)) %>%
  pull(Feature) %>% sapply(function(x) x %>% str_split(': ') %>% .[[1]] %>% .[1] %>% str_replace_all('-','.'))
f = as.formula(paste0('Progression~',paste(to_test,collapse = '+')))
m7 = summary(glm(f, family= 'binomial', data = df[df$Sample %in% train_set$Sample,] %>% 
                   filter(Progression != 'Med') %>% droplevels))$coefficients %>% 
  as.matrix() %>% as.data.frame() %>% 
  rownames_to_column('Variable')
p7 = make_plot(m7,"COG & Covar",df)

ggarrange(p6,p7)

# KO ~~~~~~~~~~~~~
df = read.csv('../../PD_2023_RF_Analysis/Datasets/FOR RF - Progression - KO.csv') %>% 
  filter(Status=='PD') %>% select(-Status) %>% 
  mutate(Progression = factor(Progression, levels = c("Slow",'Med','Fast')),
         Sex = as.numeric(Sex=='Male')) %>% 
  select(-Estimate,-current_smoker)
names(df) = sapply(names(df),function(x)x %>% str_split('[.][.]') %>% .[[1]] %>% .[1])
cov = c('bristol','Sex','logcoffeeperday')
taxa = names(df %>% select(-all_of(cov),-Sample,-Progression,-bp))

# Taxa
to_test = imp4 %>% filter(Data=='KO') %>% filter(Importance>top_terms*max(.$Importance)) %>%
  pull(Feature) %>% sapply(function(x) x %>% str_split(': ') %>% .[[1]] %>% .[1] %>% str_replace_all('-','.'))
f = as.formula(paste0('Progression~',paste(to_test,collapse = '+')))
m8 = summary(glm(f, family= 'binomial', data = df[df$Sample %in% train_set$Sample,] %>% 
                   filter(Progression != 'Med') %>% droplevels))$coefficients %>% 
  as.matrix() %>% as.data.frame() %>% 
  rownames_to_column('Variable')
p8 = make_plot(m8,"KO",df)

# Taxa, Covars
to_test = imp4 %>% filter(Data=='KO & Covar') %>% filter(Importance>top_terms*max(.$Importance)) %>%
  pull(Feature) %>% sapply(function(x) x %>% str_split(': ') %>% .[[1]] %>% .[1] %>% str_replace_all('-','.'))
f = as.formula(paste0('Progression~',paste(to_test,collapse = '+')))
m9 = summary(glm(f, family= 'binomial', data = df[df$Sample %in% train_set$Sample,] %>% 
                   filter(Progression != 'Med') %>% droplevels))$coefficients %>% 
  as.matrix() %>% as.data.frame() %>% 
  rownames_to_column('Variable')
p9 = make_plot(m9,"KO & Covar",df)

ggarrange(p8,p9)

# EC~~~~~~~~~~~~~~~~~~~~~~
df = read.csv('../../PD_2023_RF_Analysis/Datasets/FOR RF - Progression - EC.csv',check.names = F) %>% 
  filter(Status=='PD') %>% select(-Status) %>% 
  mutate(Progression = factor(Progression, levels = c("Slow",'Med','Fast')),
         Sex = as.numeric(Sex=='Male')) %>% 
  select(-Estimate,-current_smoker)
cov = c('bristol','Sex','logcoffeeperday')
taxa = names(df %>% select(-all_of(cov),-Sample,-Progression,-bp))

# Taxa
to_test = imp4 %>% filter(Data=='EC') %>% filter(Importance>top_terms*max(.$Importance)) %>%
  pull(Feature)
f = as.formula(paste0('Progression~',paste(paste('`',to_test,'`',sep=''),collapse = '+')))
m10 = summary(glm(f, family= 'binomial', data = df[df$Sample %in% train_set$Sample,] %>% 
                   filter(Progression != 'Med') %>% droplevels))$coefficients %>% 
  as.matrix() %>% as.data.frame() %>% 
  rownames_to_column('Variable') %>% 
  mutate(Variable = str_remove_all(Variable,'`'))
p10 = make_plot(m10,"EC",df)

# Taxa, Covars
to_test = imp4 %>% filter(Data=='EC & Covar') %>% filter(Importance>top_terms*max(.$Importance)) %>%
  pull(Feature)
f = as.formula(paste0('Progression~',paste(paste('`',to_test,'`',sep=''),collapse = '+')))
m11 = summary(glm(f, family= 'binomial', data = df[df$Sample %in% train_set$Sample,] %>% 
                   filter(Progression != 'Med') %>% droplevels))$coefficients %>% 
  as.matrix() %>% as.data.frame() %>% 
  rownames_to_column('Variable') %>% 
  mutate(Variable = str_remove_all(Variable,'`'))
p11 = make_plot(m11,"EC & Covar",df)

ggarrange(p10,p11)
```

```{r Save Plots and Stats}
g1 = ggarrange(p1,nrow=2)
g2 = ggarrange(p2,p3,nrow=2)
g3 = ggarrange(p4,p5,nrow=2)
g4 = ggarrange(p6,p7,nrow=2)
g5 = ggarrange(p8,p9,nrow=2)
g6 = ggarrange(p10,p11,nrow=2)

# Metabolites not included because there are too few samples to be reliable.

ggarrange(g1,g2,g3,ncol=3)
ggsave('../Results/6. Random Forest/Model Fits - Progression p1.jpeg',height=6, width=9)
ggarrange(g4,g6,g5,ncol=3)
ggsave('../Results/6. Random Forest/Model Fits - Progression p2.jpeg',height=6, width=9)

# Save model stats
modeldata = p1$data %>% mutate(Data='Covar') %>% 
  rbind(p2$data %>% mutate(Data='Taxonomy')) %>% 
  rbind(p3$data %>% mutate(Data='Taxonomy & Covar')) %>% 
  rbind(p4$data %>% mutate(Data='MetaCyc')) %>% 
  rbind(p5$data %>% mutate(Data='MetaCyc & Covar')) %>% 
  rbind(p6$data %>% mutate(Data='COG')) %>% 
  rbind(p7$data %>% mutate(Data='COG & Covar')) %>% 
  rbind(p8$data %>% mutate(Data='KO')) %>% 
  rbind(p9$data %>% mutate(Data='KO & Covar')) %>% 
  rbind(p10$data %>% mutate(Data='EC')) %>% 
  rbind(p11$data %>% mutate(Data='EC & Covar')) %>% 
  select(Data,group,everything()) %>% select(-`.group`) 
modeldata.train = modeldata %>% 
  filter(group=="Train") %>% 
  group_by(Data) %>% 
  group_modify(~wilcox.test(value~Progression,data=.) %>% broom::tidy()) %>% 
  mutate(comparison = 'Slow vs Fast',group = 'Train')
modeldata.test1 = modeldata %>% 
  filter(group=="Test",Progression!='Med') %>% 
  group_by(Data) %>% 
  group_modify(~wilcox.test(value~Progression,data=.) %>% broom::tidy()) %>% 
  mutate(comparison = 'Slow vs Fast',group = 'Test')
modeldata.test2 = modeldata %>% 
  filter(group=="Test",Progression!='Fast') %>% 
  group_by(Data) %>% 
  group_modify(~wilcox.test(value~Progression,data=.) %>% broom::tidy()) %>% 
  mutate(comparison = 'Slow vs Med',group = 'Test')
modeldata.stats = rbind(modeldata.train,modeldata.test1,modeldata.test2) %>% 
  mutate(method='Wilcoxon rank sum') %>% 
  select(Data,group,comparison,method,statistic,p.value) %>% 
  mutate(Data = factor(Data,levels = c('Covar',sort(unique(.$Data))[sort(unique(.$Data))!='Covar']))) %>% 
  arrange(Data)

write.csv(modeldata.stats,'../Results/6. Random Forest/Model Fit - Plot Statistics - Progression.csv',row.names = F)
```
